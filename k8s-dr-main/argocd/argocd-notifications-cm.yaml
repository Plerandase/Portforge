apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: default
data:
  # ArgoCD URL ì„¤ì •
  context: |
    argocdUrl: https://argocd.portforge.org
  
  # ê¸°ë³¸ êµ¬ë… ì„¤ì • ì œê±° - Applicationë³„ë¡œ annotationsì—ì„œ ì„¤ì •
  
  # Slack ì„œë¹„ìŠ¤ ì„¤ì • (Bot Token ë°©ì‹)
  service.slack: |
    token: $slack-token
  
  # Pod ì¬ìƒì„± ê°ì§€ íŠ¸ë¦¬ê±° (ì œê±°ë¨ - sync-succeededì™€ ì¤‘ë³µ)
  
  # Pod ìƒíƒœ ë³€ê²½ ê°ì§€ ì œê±°ë¨ (sync-succeededì™€ ê±°ì˜ ë™ì‹œ ë°œìƒìœ¼ë¡œ ì¤‘ë³µ)
  
  trigger.on-health-degraded: |
    - description: Application has degraded
      send:
      - app-health-degraded
      when: app.status.health.status == 'Degraded'
  
  trigger.on-sync-failed: |
    - description: Application syncing has failed
      send:
      - app-sync-failed
      when: app.status.operationState.phase in ['Error', 'Failed']
  
  trigger.on-sync-running: |
    - description: Application is being synced
      send:
      - app-sync-running
      when: app.status.operationState != nil and app.status.operationState.phase in ['Running']
  
  trigger.on-sync-progressing: |
    - description: Application sync succeeded but health is still progressing
      send:
      - app-sync-progressing
      when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Progressing'
  
  trigger.on-sync-succeeded: |
    - description: Application sync completed successfully and is healthy
      send:
      - app-sync-succeeded
      when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded'] and app.status.operationState.operation.sync != nil and app.status.health.status == 'Healthy'
  
  # app-deployed í…œí”Œë¦¿ ì œê±°ë¨ (sync-succeededì™€ ì¤‘ë³µ)
  # app-pods-ready í…œí”Œë¦¿ ì œê±°ë¨ (sync-succeededì™€ ì¤‘ë³µ)
  
  template.app-health-degraded: |
    message: |
      âš ï¸ *{{.app.metadata.name}}* ìƒíƒœ ì´ìƒ ê°ì§€
      
      â€¢ Health: {{.app.status.health.status}}
    slack:
      attachments: |
        [{
          "color": "warning",
          "fields": [
            {
              "title": "Application",
              "value": "{{.app.metadata.name}}",
              "short": true
            },
            {
              "title": "Health Status",
              "value": "{{.app.status.health.status}}",
              "short": true
            }
          ]
        }]
  
  template.app-sync-failed: |
    message: |
      âŒ *{{.app.metadata.name}}* ë™ê¸°í™” ì‹¤íŒ¨
      
      â€¢ Sync: {{.app.status.sync.status}}
    slack:
      attachments: |
        [{
          "color": "danger",
          "fields": [
            {
              "title": "Application",
              "value": "{{.app.metadata.name}}",
              "short": true
            },
            {
              "title": "Sync Status",
              "value": "{{.app.status.sync.status}}",
              "short": true
            }
          ]
        }]
  
  template.app-sync-running: |
    message: |
      ğŸ”„ *{{.app.metadata.name}}* ë™ê¸°í™” ì§„í–‰ ì¤‘
      
      â€¢ ë‹¨ê³„: {{.app.status.operationState.phase}}
      â€¢ ì§„í–‰ë¥ : ë™ê¸°í™” ì¤‘...
    slack:
      attachments: |
        [{
          "color": "#439FE0",
          "fields": [
            {
              "title": "ì• í”Œë¦¬ì¼€ì´ì…˜",
              "value": "{{.app.metadata.name}}",
              "short": true
            },
            {
              "title": "ì§„í–‰ ë‹¨ê³„",
              "value": "{{.app.status.operationState.phase}}",
              "short": true
            }
          ]
        }]
  
  template.app-sync-progressing: |
    message: |
      â³ *{{.app.metadata.name}}* ë°°í¬ ì§„í–‰ ì¤‘
      
      â€¢ ë™ê¸°í™”: {{.app.status.sync.status}}
      â€¢ í—¬ìŠ¤ ìƒíƒœ: {{.app.status.health.status}} (Pod ì‹œì‘ ì¤‘...)
      â€¢ ì´ë¯¸ì§€ íƒœê·¸: {{.app.status.sync.revision | substr 0 7}}
      
      ğŸ’¡ Podê°€ ì •ìƒ ì‹œì‘ë˜ë©´ ì™„ë£Œ ì•Œë¦¼ì„ ë³´ë‚´ë“œë¦´ê²Œìš”!
    slack:
      attachments: |
        [{
          "color": "warning",
          "fields": [
            {
              "title": "ì• í”Œë¦¬ì¼€ì´ì…˜",
              "value": "{{.app.metadata.name}}",
              "short": true
            },
            {
              "title": "ë™ê¸°í™” ìƒíƒœ",
              "value": "{{.app.status.sync.status}}",
              "short": true
            },
            {
              "title": "í—¬ìŠ¤ ìƒíƒœ",
              "value": "{{.app.status.health.status}}",
              "short": true
            },
            {
              "title": "ì´ë¯¸ì§€ íƒœê·¸",
              "value": "{{.app.status.sync.revision | substr 0 7}}",
              "short": true
            }
          ]
        }]
  
  template.app-sync-succeeded: |
    message: |
      ğŸ‰ *{{.app.metadata.name}}* ë°°í¬ ì™„ë£Œ!
      
      â€¢ ë™ê¸°í™”: {{.app.status.sync.status}}
      â€¢ í—¬ìŠ¤ ìƒíƒœ: {{.app.status.health.status}} âœ…
      â€¢ ì´ë¯¸ì§€ íƒœê·¸: {{.app.status.sync.revision | substr 0 7}}
      
      ğŸš€ ëª¨ë“  Podê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!
    slack:
      attachments: |
        [{
          "color": "good",
          "fields": [
            {
              "title": "ì• í”Œë¦¬ì¼€ì´ì…˜",
              "value": "{{.app.metadata.name}}",
              "short": true
            },
            {
              "title": "ë™ê¸°í™” ìƒíƒœ",
              "value": "{{.app.status.sync.status}}",
              "short": true
            },
            {
              "title": "í—¬ìŠ¤ ìƒíƒœ",
              "value": "{{.app.status.health.status}}",
              "short": true
            },
            {
              "title": "ì´ë¯¸ì§€ íƒœê·¸",
              "value": "{{.app.status.sync.revision | substr 0 7}}",
              "short": true
            }
          ]
        }]
